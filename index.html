<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="./vendor/codemirror.min.css" />
        <link rel="stylesheet" href="./vendor/bootstrap.min.css" />
        <link rel="stylesheet" href="./vendor/monokai.min.css" />
        <script src="./vendor/jquery-2.1.1-beta1.min.js"></script>
        <script src="./vendor/codemirror.min.js"></script>
        <script src="./vendor/htmlmixed.min.js"></script>
        <script src="./vendor/javascript.min.js"></script>
        <script src="./vendor/clike.min.js"></script>
        <script src="./vendor/sql.min.js"></script>
        <script src="./vendor/xml.min.js"></script>
        <script src="./vendor/css.min.js"></script>
        <script src="./vendor/python.min.js"></script>
        <script src="./vendor/markdown.min.js"></script>
        <script src="./vendor/bootstrap.min.js"></script>
	    <script src="./vendor/lz-string-1.3.3-min.js"></script>

        <!-- Comment the above and uncomment below to use CDN 

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/codemirror.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/theme/monokai.min.css" />
        <script src="//code.jquery.com/jquery-2.1.1-beta1.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/codemirror.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/htmlmixed/htmlmixed.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/javascript/javascript.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/clike/clike.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/sql/sql.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/xml/xml.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/css/css.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/python/python.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/markdown/markdown.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
        <script src="./vendor/lz-string-1.3.3-min.js"></script>

        -->

        <meta charset="utf-8">
        <title>SockBin</title>
        <style id="jsbin-css">
            html, body { 
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
                background: #272822;
            }
            body {
                padding-top: 45px;
            }
            #headerbar {
                padding: 10px;
                background: #2d2e28;
                height: 44px;
                position: fixed;
                top: 0;
                z-index: 5;
                width: 100%;
                border-bottom: 1px solid #33352e;
            }
            #headerbar > * {
                float: right;
                margin-left: 0.75em;
            }
            #headerbar h1 {
                color: #993344;
                padding: 0;
                margin: 0 0.3em;
                font-family: "Segoe UI";
                line-height: 22px;
                float:left;
                font-size: 1.5em;
                font-weight: bold;
                cursor: default;
            }
            #headerbar h1 .dark {
                color: #888;
            }
            #headerbar h1 .light {
                color: #666;
            }
            #headerbar h1 .faded {
                color: #555;
            }
            .CodeMirror {
                clear:both;
                height: auto;
                font-family: Consolas, monospace;
                border-bottom: 1px solid #eee;
            }
            .CodeMirror.cm-s-monokai {
                border-bottom: 1px solid #33352e;
            }
            .cm-s-monokai .CodeMirror-scroll {
                overflow-y: hidden;
                overflow-x: auto;
            }
            .cm-s-monokai .CodeMirror-gutters {
                background: #2d2e28 !important;
            }
            .CodeMirror-linenumber {
                color: #666 !important;
            }
            #channel-name {
                cursor: pointer;
            }
            #user-count {
                position: relative;
                top: 0.2em;
                line-height: 1.2em;
                border-radius: 2em;
                cursor:default;
            }
            #mode-container {
                width: 140px;
            }
            #mode {
                font-size: 0.75em;
                padding: 0.2em 0.5em;
                height: 23px;
            }
            #lock-indicator {
                height: 1em;
                width: 1em;
                border-radius: 0.5em;
                position:relative;
                top: 0.4em;
                background-color: #993344;
                float:left;
                margin-left: 0;
                cursor: pointer;
                opacity: 0.35;
            }
            .CodeMirror-gutter.activity {
                width: 0.35em;
            }
        </style>
    </head>
    <body>
        <div id="headerbar">
            <h1>SOCK<span class="dark">BIN</span><span class="faded">#</span><span id="channel-name" class="light"></span></h1>
            <div id="mode-container">
                <select id="mode" class="form-control">
                    <option value="markdown">Markdown</option>
                    <option value="htmlmixed">Mixed HTML/JS/CSS</option>
                    <option value="javascript">Javascript</option>
                    <option value="text/x-csharp">C#</option>
                    <option value="text/x-java">Java</option>
                    <option value="text/x-mariadb">SQL</option>
                    <option value="python">Python</option>
                    <option value="xml">XML</option>
                    <option value="">Plaintext</option>
                </select>
            </div>
            <span id="user-count" class="label label-default"></span>
            <div id="lock-indicator" title="Go ahead! No one is editing."></div>
        </div>
        <textarea id="miku"></textarea>
        <script>
        var SockBin = function(initChannel) {
            var me = this;
            var ws = null;
            var previousContent = null;
            var defaultContent = atob("SGkhIFRoaXMgaXMgU29ja0Jpbi4KPT09PT09PT09PT09PT09PT09PT0KClNvY2tCaW4gaXMgbWVhbnQgdG8gYmUgdXNlZCBmb3I6CgoqIAlRdWljayBjb2RlIHNoYXJpbmcgKGEgbGEgcGFzdGViaW4pCiogCUFkLWhvYyBwZWVyIHJldmlldyAoImNhbiB5b3UgZml4IHRoZSBidWcgaW4gdGhpcyBhbGdvcml0aG0/IikKKiAJUmV2aXNpbmcgYW55IHNvcnQgb2YgY29udGVudCBiZXR3ZWVuIHR3byBvciBtb3JlIHBlb3BsZQoqIAlEZW1vbnN0cmF0aW5nIGFuZCB0ZWFjaGluZyBjb2RlCgpQbGVhc2UgTm90ZToKCiogCUVkaXRzIGFyZSBtYWRlIGluIHJlYWwgdGltZSBiZXR3ZWVuIGFsbCB1c2Vycywgc28gKkNPTkZMSUNUUyBXSUxMIE9DQ1VSKgoJaWYgbW9yZSB0aGFuIG9uZSBwZXJzb24gaXMgbWFraW5nIGNoYW5nZXMgYXQgdGhlIHNhbWUgdGltZS4KKglXaGVuIGV2ZXJ5b25lIGhhcyBsZWZ0IHRoZSBjaGFubmVsLCB0aGUgY29kZSB3aWxsIGJlICpERUxFVEVEIEZPUkVWRVIqCioJTWFrZSBzdXJlIHRvICpTQVZFIFlPVVIgV09SSyogYmVmb3JlIHlvdSBnbwogICAgICAgIApIYXZlIGZ1biBhbmQgaGFwcHkgY29kaW5nIQoKCUNvcHkgdGhlIFVSTCBmcm9tIHRoZSBhZGRyZXNzIGJhciB0byBzaGFyZSB0aGlzIGNoYW5uZWwgd2l0aCBvdGhlcnMuCg==");
            var lockTimer = null;
            me.lastRemoteEditPosition = 0;

            function sendMessage(command, payload) {
                ws.send(JSON.stringify({command: command, payload: payload}));
            }

            function lock() {
                editor.setOption("readOnly", true);
                $("#lock-indicator").css("opacity", 1).attr('title', "Hang on, someone's making some changes...");
            }
            function unlock() {
                editor.setOption("readOnly", false);
                $("#lock-indicator").css("opacity", 0.35).attr('title', "Go ahead! No one is editing.");
            }

            // CLient side calls
            me.openChannel = function(channel) {
                if (ws) {
                    ws.close()
                }
                ws = new WebSocket("ws://sockbin.wintermornings.net:30000/" + channel);
                ws.onopen = function() {
                    sendMessage("load")
                };
                ws.onmessage = function(e) {
                    var data = JSON.parse(e.data);
                    remote[data.command](data.payload);
                };
            };
            me.update = function (newContent) {
                if ((newContent != previousContent && previousContent != null) || (previousContent == null && newContent != defaultContent)) {
                    sendMessage("update", {content: LZString.compressToBase64(newContent), position: editor.getCursor().line});
                    previousContent = newContent
                }
            };
            me.setMode = function (mode) {
                sendMessage("set_mode", mode);
            };


            // Server side calls (RPC)
            var remote = {
                update: function(content) {
                    content = LZString.decompressFromBase64(content);
                    if (content === null || (previousContent == null && content == "")) {
                        editor.setValue(defaultContent)
                    }
                    else {
                        if (lockTimer !== null)
                            clearTimeout(lockTimer);
                        lock();
                        previousContent = content;
                        editor.setValue(content);
                        lockTimer = setTimeout(unlock, 1000);
                    }
                },
                setMode: function(mode) {
                    editor.setOption("mode", mode);
                    $("#mode").val(mode);
                },
                setUserCount: function(count) {
                    $("#user-count").text(count).attr("title", count == 1 ? "You're the only one here" : count + " users currently in this channel")
                },
                setCursor: function(position) {
                    function makeMarker() {
                        var marker = document.createElement("div");
                        marker.style.color = "#993344";
                        marker.innerHTML = "█";
                        marker.style.fontSize = "0.65em";
                        marker.style.lineHeight = "1.4em";
                        marker.style.marginLeft = "3px";
                        return marker;
                    }
                    editor.clearGutter('activity');
                    editor.setGutterMarker(position, "activity", makeMarker());
                    me.lastRemoteEditPosition = position;
                    // The following line makes the window scroll to the remote editor's position
                    // window.scrollTo(0, editor.heightAtLine(position) - 44)
                }
            }

            if (initChannel) {
                me.openChannel(initChannel);
            }
        };
        $(function() {

            var channel = document.location.hash.substring(1, document.location.hash.length);
            if (!channel) {
                channel = "lobby"
                document.location.hash = "#" + channel;
            }
            var app = new SockBin(channel);
            $("#channel-name").text(channel);
            document.title = "SockBin#"+channel;

            window.editor = CodeMirror.fromTextArea($("#miku")[0], {
                mode: "text/html",
                indentUnit: 4,
                tabSize: 4,
                mode: "markdown",
                autofocus: true,
                theme: "monokai",
                lineNumbers: true,
                lineWrapping: true,
                indentWithTabs: false,
                gutters: ['activity', 'CodeMirror-linenumbers']
            });

            editor.on("change", function() {
                var content = editor.getValue();
                app.update(content);
            });

            $("#mode").change(function() {
                editor.setOption("mode", $(this).val());
                app.setMode($(this).val());
            })

            $(window).on('hashchange', function() {
                var channel = document.location.hash.substring(1, document.location.hash.length);
                app.openChannel(channel);
                $("#channel-name").text(channel);
                document.title = "SockBin#"+channel;
            });

            $("#channel-name").click(function() {
                var destination = prompt("Change channel?");
                if (destination && destination.length > 0) {
                    document.location.hash = "#" + destination;
                }
            })

            $("#lock-indicator").click(function() {
                window.scrollTo(0, editor.heightAtLine(app.lastRemoteEditPosition) - 44)
            });
        });
        </script>
    </body>
</html>
