<!DOCTYPE html>
<html>
    <head>
	<!--

        <link rel="stylesheet" href="./vendor/codemirror.min.css" />
        <link rel="stylesheet" href="./vendor/bootstrap.min.css" />
        <link rel="stylesheet" href="./vendor/monokai.min.css" />
        <script src="./vendor/jquery-2.1.1-beta1.min.js"></script>
        <script src="./vendor/codemirror.min.js"></script>
        <script src="./vendor/htmlmixed.min.js"></script>
        <script src="./vendor/javascript.min.js"></script>
        <script src="./vendor/clike.min.js"></script>
        <script src="./vendor/sql.min.js"></script>
        <script src="./vendor/xml.min.js"></script>
        <script src="./vendor/css.min.js"></script>
        <script src="./vendor/python.min.js"></script>
        <script src="./vendor/markdown.min.js"></script>
        <script src="./vendor/bootstrap.min.js"></script>

        Uncomment the above and comment below to use CDN -->

        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.2.0/codemirror.min.css" />
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.2.0/theme/base16-light.min.css" />
        <script src="//code.jquery.com/jquery-2.1.1-beta1.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.2.0/codemirror.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.2.0/mode/htmlmixed/htmlmixed.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.2.0/mode/javascript/javascript.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.2.0/mode/clike/clike.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.2.0/mode/sql/sql.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.2.0/mode/xml/xml.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.2.0/mode/css/css.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.2.0/mode/python/python.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.2.0/mode/markdown/markdown.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel='shortcut icon' type='image/x-icon' href='./favicon.ico' />
        <meta charset="utf-8">
        <title>LiveBin</title>
        <style id="jsbin-css">
            html, body { 
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
                background: #f9f9f9;
            }
            body {
                padding-top: 44px;
                height: 100%;
            }
            #headerbar {
                padding: 10px;
                background: #f9f9f9;
                height: 44px;
                position: fixed;
                top: 0;
                z-index: 5;
                width: 100%;
                border-bottom: 1px solid #ddd;
                transition: 0.5s padding-right;
            }
            #headerbar > * {
                float: right;
                margin-left: 0.75em;
            }
            #headerbar h1 {
                color: #cc7788;
                padding: 0;
                margin: 0 0.3em;
                font-family: "Segoe UI";
                line-height: 22px;
                float:left;
                font-size: 1.5em;
                font-weight: bold;
                cursor: default;
            }
            .dark {
                color: #aaa;
            }
            .light {
                color: #999;
            }
            .faded {
                color: #ccc;
            }
            .CodeMirror {
                width: 100%;
                clear:both;
                height: auto;
                font-family: Consolas, monospace;
                border-bottom: 1px solid #ddd;
            }
            .CodeMirror.cm-s-monokai {
                border-bottom: 1px solid #33352e;
            }
            .cm-s-monokai .CodeMirror-scroll {
                overflow-y: hidden;
                overflow-x: auto;
            }
            .cm-s-monokai .CodeMirror-gutters {
                background: #2d2e28 !important;
            }
            #channel-name {
                cursor: pointer;
            }
            #user-count, #connection-status {
                position: relative;
                top: 0.2em;
                line-height: 1.2em;
                border-radius: 2em;
                cursor:default;
            }
            #user-count:after {
                content: " online";
            }
            #mode-container {
                width: 140px;
            }
            #mode {
                font-size: 0.75em;
                padding: 0.2em 0.5em;
                height: 23px;
            }
            #lock-indicator {
                height: 1em;
                width: 1em;
                border-radius: 0.5em;
                position:relative;
                top: 0.4em;
                background-color: #993344;
                float:left;
                margin-left: 0;
                cursor: pointer;
                opacity: 0.35;
            }
            .CodeMirror-gutter.activity {
                width: 0.35em;
            }
            #main-area {
                transition: 0.5s padding-right;
            }
            #chat-area {
                position: fixed;
                right: 0;
                top: 0;
                height: 100%;
                width: 0px;
                background: #f9f9f9;
                border-left: 1px solid #ddd;
                transition: 0.5s width;
            }
            #chat-header {
                background: #f5f5f5;
                position: fixed;
                top: 0;
                right: 0;
                height: 44px;
                width: 0px;
                transition: 0.5s width;
                border-left: 1px solid #ddd;
                border-bottom: 1px solid #ddd;
            }
            #chat-toggle {
                color: #ddd;
                font-size: 1.5em;
                cursor: pointer;
                position: relative;
                right: 0.2em;
                transition: 0.3s all;
            }
            #chat-toggle:hover {
                color: #aaa;
            }
            .chat-enabled #headerbar { 
                padding-right: 410px; 
            }
            .chat-enabled #main-area { 
                padding-right: 400px; 
            }
            .chat-enabled #chat-area { 
                width: 400px; 
                z-index: 10;
            }
            .chat-enabled #chat-header { 
                width: 400px; 
                z-index: 15;
            }
            .chat-enabled #messages { 
                width: 415px; 
            }
            
            #message-sender {
                position: fixed;
                bottom: 0;
                width: 100%;
                display: block;
            }
            #message-sender input[type=text] {
                border: none;
                border-top: 1px solid #ddd;
                height: 44px;
                width: 400px;
                font-size: 1em;
                outline: none !important;
                padding: 10px;
                color: #444;
            }
            
            #messages {
                padding: 44px 0 44px 0;
                height: 100%;
                width: 0px;
                position: fixed;
                right: -15px;
                top: 0;
                overflow-y: auto;
                overflow-x: hidden;
                transition: 0.5s width;
            }
            #messages .message {
                border-bottom: 1px solid #eee;
                padding: 10px;
            }
            #messages .message:last-child {
                border-bottom: none;
            }
            #messages .message .username {
                clear: left;
                float: left;
                font-size: 0.9em;
                line-height: 1.8em;
                margin-right: 0.5em;
                color: #bbb;
                font-weight: bold;
            }
            #messages .message .content {
                float: left;
                font-size: 1em;
                color: #444;
                margin-bottom: 0.3em;
                word-wrap: break-word;
                max-width: 380px;
            }
            #username-container {
                font-size: 1.5em;
                font-weight: bold;
                font-family: "Segoe UI";
                text-align: center;
                margin-top: 4px;
                cursor: pointer;
            }
        </style>
    </head>
    <body class="chat-enabled">
        <div id="main-area">
            <div id="headerbar">
                <h1>LIVE<span class="dark">BIN</span><span class="faded">#</span><span id="channel-name" class="light"></span></h1>
                <div id="mode-container">
                    <select id="mode" class="form-control">
                        <option value="markdown">Markdown</option>
                        <option value="htmlmixed">Mixed HTML/JS/CSS</option>
                        <option value="text/x-less">LESS/CSS</option>
                        <option value="javascript">Javascript</option>
                        <option value="text/x-csharp">C#</option>
                        <option value="text/x-java">Java</option>
                        <option value="text/x-mariadb">SQL</option>
                        <option value="python">Python</option>
                        <option value="xml">XML</option>
                        <option value="">Plaintext</option>
                    </select>
                </div>
                <span id="chat-toggle" class="glyphicon glyphicon-comment" title="Show &amp; hide the chat pane"></span>
                <span id="user-count" class="label label-info"></span>
                <span id="connection-status" class="label label-danger">Connecting...</span>
                <div id="lock-indicator" title="Go ahead and make a change! No one is editing."></div>
            </div>
            <textarea id="miku"></textarea>
        </div>
        <div id="chat-area">
            <div id="messages"></div>
            <form id="message-sender">
                <input id="message-content" type="text" placeholder="Send a message..."></input>
            </form>    
            <div id="chat-header">
                <div id="username-container">
                    <span class="faded">@</span><span id="username" class="light"></span>
                </div>
            </div>
        </div>
        <script>
        var LiveBin = function(initChannel) {
            var me = this;
            var ws = null;
            var lockTimer = null;
            me.lastRemoteEditPosition = 0;
            var locked = false;
            var username = null;
            var usernameColorMap = {};

            function sendMessage(command, payload) {
                if (ws && ws.readyState == 1) {
                    ws.send(JSON.stringify({command: command, payload: payload}));
                } else {
                    $("#connection-status").show();
                }
            }

            function lock() {
                locked = true;
                editor.setOption("readOnly", true);
                $("#lock-indicator").css("opacity", 1).attr('title', "Hang on, someone's making some changes...");
            }
            function unlock() {
                locked = false;
                editor.setOption("readOnly", false);
                $("#lock-indicator").css("opacity", 0.35).attr('title', "Go ahead and make a change! No one is editing.");
            }
            
            function uiRenderChat(message) {
                var $messages = $("#messages");
                var wasAtEnd = $messages.scrollTop() + $messages.outerHeight() >= $messages[0].scrollHeight - 50;
                $messages.append(
                    $("<div>")
                        .addClass("message")
                        .append(
                            $("<span>")
                                .addClass("username")
                                .css("color", getUsernameColor(message.username))
                                .text(message.username)
                        )
                        .append($("<span>").addClass("content").text(message.content))
                        .append($("<div>").css("clear", "both"))
                );
                if (wasAtEnd) {
                    uiScrollChatToBottom();
                }
            }
            
            function uiScrollChatToBottom() {
                $("#messages").animate({ scrollTop: $("#messages")[0].scrollHeight}, 500);
            }
            
            function generateUsername() {
                var result = "";
                var consonants = "bcdfghjklmnpqrstvwxz";
                var vowels = "aeiouy";
                var numerals = "123456789";
            
                for (var i = 0; i < 5; i++) {
                    var charset = i % 2 == 0 ? consonants : vowels;
                    result += charset.charAt(Math.floor(Math.random() * charset.length));
                }
                
                result += "_";
                
                for (var i = 0; i < 2; i++) {
                    result += numerals.charAt(Math.floor(Math.random() * numerals.length));
                }
            
                return result;
            }
            
            function getUsernameColor(username) {
                var randomColors = kelly_colors_hex = [
                    "#FFB300",
                    "#803E75",
                    "#FF6800",
                    "#A6BDD7",
                    "#C10020",
                    "#CEA262",
                    "#817066",
                    "#007D34",
                    "#F6768E",
                    "#00538A",
                    "#FF7A5C",
                    "#53377A",
                    "#FF8E00",
                    "#B32851",
                    "#F4C800",
                    "#7F180D",
                    "#93AA00",
                    "#593315",
                    "#F13A13",
                    "#232C16",
                ];
                if (!usernameColorMap.hasOwnProperty(username)) {
                    usernameColorMap[username] = randomColors[Math.floor(Math.random() * randomColors.length)];
                }
                return usernameColorMap[username];
            }
            
            me.setUsername = function(name) {
                localStorage.setItem("username", name);
                username = name;
                $("#username").text(name);
            };
            
            me.getUsername = function() {
                return username || localStorage.getItem("username");
            };

            // Client side calls
            me.openChannel = function(channel) {
                if (ws) {
                    ws.close();
                    editor.setValue("");
                }
                ws = new WebSocket("wss://wintermornings.net/livebin/api/" + channel);
                ws.onopen = function() {
                    sendMessage("load");
                    $("#connection-status").hide();
                };
                ws.onmessage = function(e) {
                    var data = JSON.parse(e.data);
                    remote[data.command](data.payload);
                };
            };
            me.update = function (changeObj) {
                if (!locked) {
                    sendMessage("update", changeObj);
                }
            };
            me.setMode = function (mode) {
                sendMessage("set_mode", mode);
            };
            me.sendChat = function(message) {
                uiScrollChatToBottom();
                uiRenderChat(message);
                sendMessage("chat", message);
            };


            // Server side calls (RPC)
            var remote = {
                update: function(changeObj) {
                    if (lockTimer !== null)
                        clearTimeout(lockTimer);
                    lock();
                    if (editor.getValue() === "") { // Detect first "update", set initial value
                        editor.setValue(changeObj.text.join("\n"));
                        // Hack to get codemirror to re-render code on first populate, otherwise with word wrap it glitches up and shows only one line.
                        // The hack seems to fix it by triggering some internal thingy in codemirror which happens on resize
                        if (window.hasOwnProperty("dispatchEvent"))
                            window.dispatchEvent(new Event('resize'));
                    }
                    else {
                        editor.replaceRange(
                            changeObj.text.join("\n"),
                            changeObj.from,
                            changeObj.to
                        );
                    }
                    lockTimer = setTimeout(unlock, 1000);
                },
                setMode: function(mode) {
                    editor.setOption("mode", mode);
                    $("#mode").val(mode);
                },
                setUserCount: function(count) {
                    $("#user-count").text(count).attr("title", count == 1 ? "You're the only one here" : count + " users currently in this channel")
                },
                setCursor: function(position) {
                    function makeMarker() {
                        var marker = document.createElement("div");
                        marker.style.color = "#cc7788";
                        marker.innerHTML = "█";
                        marker.style.fontSize = "0.85em";
                        marker.style.lineHeight = "1.6em";
                        marker.style.marginLeft = "3px";
                        return marker;
                    }
                    editor.clearGutter('activity');
                    editor.setGutterMarker(position, "activity", makeMarker());
                    me.lastRemoteEditPosition = position;
                    // The following line makes the window scroll to the remote editor's position
                    // window.scrollTo(0, editor.heightAtLine(position) - 44)
                },
                renderChat: function(message) {
                    uiRenderChat(message);
                }
            }

            if (initChannel) {
                me.openChannel(initChannel);
                
                // Generate new username, or load old one if exists
                if (me.getUsername() == null) {
                    me.setUsername(generateUsername());
                } else {
                    me.setUsername(me.getUsername());
                }
            }
        };
        $(function() {

            var channel = document.location.hash.substring(1, document.location.hash.length);
            if (!channel) {
                channel = "lobby"
                document.location.hash = "#" + channel;
            }
            var app = new LiveBin(channel);
            $("#channel-name").text(channel);
            document.title = "LiveBin#"+channel;

            window.editor = CodeMirror.fromTextArea($("#miku")[0], {
                mode: "text/html",
                indentUnit: 4,
                tabSize: 4,
                mode: "markdown",
                theme: "base16-light",
                autofocus: true,
                lineNumbers: true,
                lineWrapping: true,
                indentWithTabs: false,
                gutters: ['activity', 'CodeMirror-linenumbers']
            });

            editor.on("change", function(e, changeObj) {;
                app.update(changeObj);
            });

            $("#mode").change(function() {
                editor.setOption("mode", $(this).val());
                app.setMode($(this).val());
            })

            $(window).on('hashchange', function() {
                var channel = document.location.hash.substring(1, document.location.hash.length);
                app.openChannel(channel);
                $("#channel-name").text(channel);
                document.title = "LiveBin#"+channel;
            });

            $("#channel-name").click(function() {
                var destination = prompt("Change channel?");
                if (destination && destination.length > 0) {
                    document.location.hash = "#" + destination;
                }
            })

            $("#lock-indicator").click(function() {
                window.scrollTo(0, editor.heightAtLine(app.lastRemoteEditPosition) - 44)
            });
            
            $("#chat-toggle").click(function() {
                $("body").toggleClass("chat-enabled");
            });
            
            $("#message-sender").submit(function(e) {
                e.preventDefault();
                var messageContent = $("#message-content").val();
                
                if (messageContent.length == 0) {
                    return false;
                }
                
                app.sendChat({
                    username: app.getUsername(),
                    content: messageContent
                });
                
                $("#message-content").val("");
            });
            
            $("#username-container").click(function(e) {
                var newUsername = prompt("Change my username to:", app.getUsername());
                if (newUsername !== null && newUsername !== "") {
                    app.setUsername(newUsername);
                }
            });
        });
        </script>
    </body>
</html>
