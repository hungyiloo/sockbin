<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/codemirror.min.css">
        <script src="//code.jquery.com/jquery-2.1.1-beta1.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/codemirror.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/htmlmixed/htmlmixed.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/javascript/javascript.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/clike/clike.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/sql/sql.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/xml/xml.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/css/css.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/4.0.3/mode/python/python.min.js"></script>
        <meta charset="utf-8">
        <title>SockBin</title>

        <style id="jsbin-css">
            html, body { 
                margin: 0;
                padding: 0;
            }
            #headerbar {
                padding: 10px;
                background: #F7F7F7;
                height: 25px;
            }
            #headerbar > select {
                float: right;
            }
            #headerbar h1 {
                color: #993344;
                padding: 0;
                margin: 0;
                font-family: "Segoe UI";
                line-height: 22px;
                float:left;
                font-size: 1.5em;
            }
            #headerbar h1 .dark {
                color: #444;
            }
            #headerbar h1 .light {
                color: #aaa;
            }
            #headerbar h1 .faded {
                color: #ccc;
            }
            .CodeMirror {
              border: 1px solid #eee;
              height: auto;
              font-family: Consolas, monospace;
            }
            .CodeMirror-scroll {
              overflow-y: hidden;
              overflow-x: auto;
            }
            #channel-name {
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div id="headerbar">
            <h1>SOCK<span class="dark">BIN</span><span class="faded">#</span><span id="channel-name" class="light"></span></h1>
            <select id="mode">
                <option value="htmlmixed">Mixed HTML/JS/CSS</option>
                <option value="javascript">Javascript</option>
                <option value="text/x-csharp">C#</option>
                <option value="text/x-java">Java</option>
                <option value="text/x-mariadb">SQL</option>
                <option value="python">Python</option>
            </select>
        </div>
        <textarea id="miku"></textarea>
        <script>
        var SockBin = function(initChannel) {
            var me = this;
            var ws = null;
            var previousContent = null;

            function sendMessage(command, payload) {
                ws.send(JSON.stringify({command: command, payload: payload}));
            }

            // CLient side calls
            me.openChannel = function(channel) {
                if (ws) {
                    ws.close()
                }
                ws = new WebSocket("ws://sockbin.wintermornings.net:30000/" + channel);
                ws.onopen = function() {
                    sendMessage("load")
                };
                ws.onmessage = function(e) {
                    var data = JSON.parse(e.data);
                    remote[data.command](data.payload);
                };
            };
            me.update = function (newContent) {
                if (newContent != previousContent) {
                    sendMessage("update", newContent);
                    previousContent = newContent
                }
            };
            me.setMode = function (mode) {
                sendMessage("set_mode", mode);
            }

            // Server side calls (RPC)
            var remote = {
                update: function(content) {
                    previousContent = content;
                    editor.setValue(content);
                },
                setMode: function(mode) {
                    editor.setOption("mode", mode);
                    $("#mode").val(mode);
                }
            }

            if (initChannel) {
                me.openChannel(initChannel);
            }
        };

        $(function() {

            var channel = document.location.hash.substring(1, document.location.hash.length);
            if (!channel) {
                channel = "lobby"
                document.location.hash = "#" + channel;
            }
            var app = new SockBin(channel);
            $("#channel-name").text(channel);

            window.editor = CodeMirror.fromTextArea($("#miku")[0], {
                mode: "text/html",
                indentUnit: 4,
                tabSize: 4,
                mode: "htmlmixed",
                lineNumbers: true,
                autofocus: true,
            });

            editor.on("change", function(){
                var content = editor.getValue();
                app.update(content);
            });

            $("#mode").change(function() {
                editor.setOption("mode", $(this).val());
                app.setMode($(this).val());
            })

            $(window).on('hashchange', function() {
                var channel = document.location.hash.substring(1, document.location.hash.length);
                app.openChannel(channel);
                $("#channel-name").text(channel);
            });

            $("#channel-name").click(function() {
                var destination = prompt("Change channel?");
                if (destination && destination.length > 0) {
                    document.location.hash = "#" + destination;
                }
            })
        });
        </script>
    </body>
</html>